<!doctype html><html lang=en><head><meta charset=utf-8><link rel="shortcut icon" href=https://luispe.github.io/blog/favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><title>Size matters - luispe</title>
<meta name=description content="How to create lightweight images and save networking and storage transfer."><meta name=author content="luispe"><meta property="og:url" content="https://luispe.github.io/blog/posts/lightweight-container-image/"><meta property="og:site_name" content="luispe"><meta property="og:title" content="Size matters"><meta property="og:description" content="How to create lightweight images and save networking and storage transfer."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-11T17:49:18-03:00"><meta property="article:modified_time" content="2022-06-11T17:49:18-03:00"><meta property="article:tag" content="Best-Practices"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Size matters"><meta name=twitter:description content="How to create lightweight images and save networking and storage transfer."><link rel=stylesheet href=/blog/style.min.2338eb9c66c01f41c1bffce87e87ab3319740a82e43f36025d401cc9fd148a50c5ef8006dfa3d577491113ec707c814ae5ff83a54ec7fe6e87b24c2e8edf8989.css integrity="sha512-IzjrnGbAH0HBv/zofoerMxl0CoLkPzYCXUAcyf0UilDF74AG36PVd0kRE+xwfIFK5f+DpU7H/m6Hskwujt+JiQ=="><link rel=stylesheet href=/blog/lib/css/prism.min.6226f06f992e0d6166b0e26724efd050dcc381202a752892ba523b1b865de2ea5e427f8f7d10de682fc35d6e7444018247d1f25db5e1e3bab17068ce191c5886.css integrity="sha512-Yibwb5kuDWFmsOJnJO/QUNzDgSAqdSiSulI7G4Zd4upeQn+PfRDeaC/DXW50RAGCR9HyXbXh47qxcGjOGRxYhg=="><script>"theme"in localStorage||(localStorage.theme="light"),localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")</script><script defer src=/blog/js/header.64a5d751579791aca02cca13ec10c056a8bb0de07cc69a70f0ef401bb0f470f2360e07f1f6f4398e0681f9abd2c64b3cb9d167ee471fa2a07bb1943e06e0c02b.js integrity="sha512-ZKXXUVeXkaygLMoT7BDAVqi7DeB8xppw8O9AG7D0cPI2Dgfx9vQ5jgaB+avSxks8udFn7kcfoqB7sZQ+BuDAKw=="></script><script defer src=/blog/js/zooming.684b5d075bf94d0adfa21a7e7eb9acec1ddfb2e7b47d6657981617f0db0cf50949f1172801595afa3051f51b28d67f6a2d0c41be677b59b564307d9dbe4a4fd2.js integrity="sha512-aEtdB1v5TQrfohp+frms7B3fsue0fWZXmBYX8NsM9QlJ8RcoAVla+jBR9Rso1n9qLQxBvmd7WbVkMH2dvkpP0g=="></script><script defer src=/blog/js/prism.ea52843de9ef49f2fd5ada5a4e0efb81dd05ae250cb815846dfa3fb988498c70ae2cc567a635da79ffd407054622cea929e1b5fa00977f69c48e373b728cb9cd.js integrity="sha512-6lKEPenvSfL9WtpaTg77gd0FriUMuBWEbfo/uYhJjHCuLMVnpjXaef/UBwVGIs6pKeG1+gCXf2nEjjc7coy5zQ==" data-manual></script><script defer src=/blog/js/search-en.e2c44e92879386fcafd7745ceb3d7e022338f304fcc2ecc4a35453c1693ba996d9a360bd1e1daf3030ae2e052b0f0efd378adad6c7714d60a540e336953de39e.js integrity="sha512-4sROkoeThvyv13Rc6z1+AiM48wT8wuzEo1RTwWk7qZbZo2C9Hh2vMDCuLgUrDw79N4ra1sdxTWClQOM2lT3jng=="></script></head><body><header><div id=header_left><div id=sidebar_btn><input type=checkbox id=sidebar_btn_input class=hidden>
<label id=sidebar_btn_label for=sidebar_btn_input><svg id="menu_icon" width="26" height="26" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</svg>
</label><label id=sidebar_canvas_overlay_wrapper for=sidebar_btn_input><div id=sidebar_canvas_overlay></div></label><div id=sidebar><ul><li><a href=/blog/about/>About</a></li><li><a href=/blog/posts/>Posts</a></li></ul></div></div><div class=brand><div><a href=/blog/>luispe</a></div></div></div><div class=toolbox><div id=theme_tool><svg id="dark_mode_btn" class="toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></svg><svg id="light_mode_btn" class="toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></svg></div><div id=search_tool><svg id="search_btn" class="toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></svg><div id=search_menu_wrapper class=hidden><div id=search_menu><div id=search_menu_toolbar><div id=search_menu_input_wrapper><input id=search_menu_input type=text placeholder='Search Posts'></div><div id=search_menu_close_btn><svg width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></svg></div></div><div id=search_menu_results></div></div></div></div><div id=translation_tool class="dropdown-wrapper pure-menu pure-menu-horizontal toolbox-btn" onclick="void 0"><ul class=pure-menu-list><li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover"><div class="dropdown-btn pure-menu-link"><svg width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3.0 014 10 15.3 15.3.0 01-4 10A15.3 15.3.0 018 12a15.3 15.3.0 014-10z"/></svg>
</svg>
<span class=dropdown-desc>English</span></div><ul class=pure-menu-children><li class=pure-menu-item><a href=https://luispe.github.io/blog/ class=pure-menu-link>English</a></li><li class=pure-menu-item><a href=https://luispe.github.io/blog/es/ class=pure-menu-link>Espa√±ol</a></li></ul></li></ul></div></div></header><nav id=navbar class=pure-menu><ul class=pure-menu-list><li class="navbar-item pure-menu-item"><a href=/blog/about/ class=pure-menu-link>About</a></li><li class="navbar-item pure-menu-item insection"><a href=/blog/posts/ class=pure-menu-link>Posts</a></li></ul></nav><main><div id=content class=content-margin><div class=collapsible-menu-wrapper><div class=collapsible-menu-type><span>Table of contents</span></div><div class=collapsible-menu><nav id=TableOfContents><ul><li><a href=#preface>Preface</a></li><li><a href=#lets-start>Let&rsquo;s start</a></li><li><a href=#proposallearning>Proposal/learning</a><ul><li><a href=#lets-go-with-the-first-proposal>Let&rsquo;s go with the first proposal.</a></li><li><a href=#second-proposal>Second proposal</a></li></ul></li></ul></nav></div></div><div class=content-margin><article><p>In the following post I am going to share with you some tips and best practices to develop our container images,
as an example we are going to create an image for an app in Golang, but the following tips apply to any language, let&rsquo;s go!</p><h2>Preface</h2><p>To make our container images as small as possible in terms of weight (megabytes, gigabytes, etc.)
is not a matter of taste, it helps us in many ways, here are some of them:</p><ul><li>Reduce storage costs in the registry we use to manage our images.</li><li>When we have to obtain the image to start the container it is clear that the lighter it is the faster the
initialization of the container will be, and with this we win in two points.<ul><li>Costs, and by costs we mean the use of the networking we use to obtain the image and then initialize the container.</li><li>Speed in auto scaling, it is clear that to obtain a 20 MB image versus a 900 MB image the first one, of course,
is going to initialize with a higher speed.</li></ul></li></ul><p>To give a few examples.</p><h2>Let&rsquo;s start</h2><p>Let us imagine that we have the following Dockerfile to create our container image e.g:</p><pre class="mc-prism hide language-text"><code>FROM golang:1.18
WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download &amp;&amp; go mod verify

COPY . ./
RUN go build -o ./myapp ./path/to/main

ENTRYPOINT [&quot;/myapp&quot;]
</code></pre><p>Let&rsquo;s build our <code>docker build -t myapp:0.0.1 .</code> image.</p><p>If we list the images that we have in our host we will be able to observe that the weight is approximately <code>968 MB</code>.</p><p>What? 968 MB just to make available a binary that weighs a few megabytes?</p><blockquote><p>NOTE</p><p>In all my publications you will find concepts, the idea is that we learn and not copy and paste.</p><p>To give an example <code>RUN go build -o ./myapp ./path/to/main</code> where <code>./path/to/main</code> should be the main of
your Golang app</p></blockquote><h2>Proposal/learning</h2><h3>Let&rsquo;s go with the first proposal.</h3><p>It is always a good practice to use <code>-alpine</code> images, by convention in the container universe when we make available
an <code>-alpine</code> image we are indicating to the client that it is an image reduced in size and the one we should use in
our Dockerfile, among other things.</p><p>Well, let&rsquo;s make a small change in our Dockerfile and build our image again</p><pre class="mc-prism hide language-text"><code>FROM golang:1.18-alpine3.16
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download &amp;&amp; go mod verify

COPY . ./
RUN go build -o ./myapp ./path/to/main

ENTRYPOINT [&quot;/myapp&quot;]
</code></pre><p>If we pay attention the change was subtle, but effective, we went from <code>FROM golang:1.18</code> to
<code>FROM golang:1.18-alpine3.16</code>.</p><p>Let&rsquo;s build our <code>docker build -t myapp:0.0.2 .</code> image again.</p><p>If we list the images again we will find that now the <code>myapp:0.0.2</code> image weighs approximately <code>331 MB</code>.</p><p>We reduce, if the accounts do not fail, 637 MB.</p><p>It&rsquo;s an excellent approach, but let&rsquo;s rethink: do you have to have an image with all of Golang inside
the container weighing about 331 MB to make available a binary that weighs a few megabytes?</p><p>The answer is clearly, no.</p><h3>Second proposal</h3><p>The container technology has an excellent feature, that for our case, will help us to build a very light
container image, in case you didn&rsquo;t know, I&rsquo;m talking about Multistage, I share with you the
<a href=https://docs.docker.com/develop/develop-images/multistage-build/>official documentation</a>
to deepen about this feature.</p><p>What does Multistage consist of? It is about building images in stages so that we can share data between each
one of them, and we will obtain a final image of a very small size.</p><p>The first thing we are going to do is to have a first stage of build, where we are going to build the binary,
and a second stage where we are going to make it available for use.</p><p>Let&rsquo;s get to work, let&rsquo;s open and make the following modifications to our Dockerfile.</p><pre class="mc-prism hide language-text"><code># First layer use to build a Golang binary
FROM golang:1.18-alpine3.16 AS builder
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download &amp;&amp; go mod verify

COPY . ./
RUN go build -o ./myapp ./path/to/main

# Final layer expose app to minimal docker image
FROM alpine:3.16.0

COPY --from=builder /build/myapp /myapp

ENTRYPOINT [&quot;/myapp&quot;]
</code></pre><p>As we can see, the first modification consists of tagging the first stage as a build.
Then in the second and final stage with the following line <code>COPY --from=builder /build/myapp /myapp</code> we copy
the binary from the stage that we have selected as <code>builder</code> and we make it available in an alpine image.</p><p>If we list now our images we can see that it weighs approximately 9 MB, yes yes,
I wrote correctly 9 megabytes &#x1f60e;.</p><p>We could do one last optimization or best practice, but I think it&rsquo;s worth leaving it for another post.</p><p>So as not to bore you and for the moment let&rsquo;s take a break.</p><p>Have a good time! üëãüèΩ</p></article></div></div></main></body></html>